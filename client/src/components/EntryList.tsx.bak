import React, { useState } from 'react';
import { useEntries, entriesApi } from '../api/entries';
import { Entry, Mood, getMoodColor } from '../types';
import ConfirmDialog from './ConfirmDialog';
import EntryForm from './EntryForm';
import FilterBar from './FilterBar';
import EntryCover from './EntryCover';
import EntryIcon from './EntryIcon';

interface EntryListProps {
  onEdit?: (entry: Entry) => void;
}

export default function EntryList({ onEdit }: EntryListProps) {
  const [filters, setFilters] = useState<{from?: string; to?: string; mood?: string; city?: string}>({});
  const { entries, isLoading, isError } = useEntries(filters);
  const [editingEntryId, setEditingEntryId] = useState<string | null>(null);
  
  // Extract unique cities for the filter dropdown
  const cities = Array.from(new Set(entries.map(entry => entry.city).filter(Boolean) as string[]));
  
  const handleDelete = async (id: string) => {
    try {
      await entriesApi.delete(id);
    } catch (error) {
      console.error('Failed to delete entry:', error);
      alert('Failed to delete entry');
    }
  };
  
  const formatDate = (dateString: string | Date) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };
  
  const getMoodEmoji = (mood: Mood) => {
    switch (mood) {
      case 'happy': return '😄';
      case 'calm': return '😌';
      case 'neutral': return '😐';
      case 'sad': return '😔';
      case 'stressed': return '😫';
      default: return '';
    }
  };
  
  if (isLoading) {
    return <div className="text-center py-8">Loading entries...</div>;
  }
  
  if (isError) {
    return (
      <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-md">
        Failed to load entries. Please try again later.
      </div>
    );
  }
  
  if (entries.length === 0) {
    return (
      <div className="text-center py-8 bg-gray-50 rounded-lg border border-gray-200">
        <p className="text-gray-500">No entries found.</p>
        <p className="text-gray-500 text-sm mt-2">Add an entry or adjust your filters.</p>
      </div>
    );
  }

  return (
    <div>
      <FilterBar 
        from={filters.from || ''} 
        to={filters.to || ''} 
        mood={filters.mood || ''} 
        city={filters.city || ''}
        cities={cities}
        onChange={changes => setFilters({...filters, ...changes})}
        onClear={() => setFilters({})}
        onApply={() => {}} // Apply happens on change
      />
      
      <div className="space-y-4">
        {entries.map(entry => (
          <div
            key={entry._id}
            className={`bg-white rounded-lg shadow-sm border-l-4 ${
              entry.mood ? getMoodColor(entry.mood as Mood) : 'border-gray-300'
            }`}
          >
            {editingEntryId === entry._id ? (
              <div className="p-4">
                <div className="flex justify-between mb-2">
                  <h3 className="font-medium">Edit Entry</h3>
                  <button
                    onClick={() => setEditingEntryId(null)}
                    className="text-gray-400 hover:text-gray-600"
                  >
                    Cancel
                  </button>
                </div>
                <EntryForm
                  initialEntry={{
                    _id: entry._id,
                    date: entry.date instanceof Date ? entry.date.toISOString().split('T')[0] : new Date(entry.date).toISOString().split('T')[0],
                    mood: entry.mood as Mood,
                    city: entry.city,
                    tags: entry.tags,
                    note: entry.note
                  }}
                  isEditing
                  onSuccess={() => setEditingEntryId(null)}
                />
              </div>
            ) : (
              <div className="p-4">
                <div className="flex justify-between items-start">
                  <div>
                    <div className="flex items-center">
                      <span className="text-xl mr-2">{getMoodEmoji(entry.mood as Mood)}</span>
                      <h3 className="font-medium capitalize">{entry.mood}</h3>
                      <span className="mx-2 text-gray-300">•</span>
                      <span className="text-gray-500 text-sm">
                        {formatDate(entry.date)}
                      </span>
                    </div>
                    
                    {entry.city && (
                      <div className="mt-1 text-gray-600 text-sm flex items-center">
                        <EntryIcon mood={entry.mood as Mood} />
                        {entry.city}
                        
                        {entry.weather && (
                          <span className="ml-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                            </svg>
                            {entry.weather.tempC !== undefined && (
                              <span>{entry.weather.tempC}°C</span>
                            )}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                  
                  <div className="flex space-x-1">
                    <button 
                      onClick={() => entry._id && setEditingEntryId(entry._id)}
                      className="p-1 text-gray-400 hover:text-indigo-600"
                      aria-label="Edit entry"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                    </button>
                    <button 
                      onClick={() => entry._id && (document.getElementById(`dlgDel-${entry._id}`) as HTMLDialogElement).showModal()}
                      className="secondary outline"
                      aria-label="Delete entry"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                    {entry._id && (
                      <ConfirmDialog 
                        id={`dlgDel-${entry._id}`} 
                        message="Are you sure you want to delete this entry?" 
                        onConfirm={() => entry._id && handleDelete(entry._id)} 
                      />
                    )}
                  </div>
                </div>
                
                {entry.tags && entry.tags.length > 0 && (
                  <div className="mt-3 flex flex-wrap gap-1">
                    {entry.tags.map(tag => (
                      <span 
                        key={tag} 
                        className="bg-gray-100 text-gray-800 px-2 py-0.5 rounded-md text-xs"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
                
                {entry.note && (
                  <div className="mt-3 text-gray-700">
                    {entry.note}
                  </div>
                )}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}